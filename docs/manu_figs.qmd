---
title: "Manuscript figures"
format: 
  html:
    code-fold: true
editor: source
bibliography: refs.bib
lightbox: true

execute: 
  warning: false
  message: false
  echo: true
---

```{r setup}
library(tidyverse)
library(patchwork)

load(file = here::here('data/tempdat.RData'))
```


```{r}
#| fig-height: 4
#| fig-width: 7
#| fig-cap: "Annual minimum daily air temperature and freezing days in Tampa, Florida (1980 - 2024). Top panel shows annual minimum daily air temperature with dashed line indicating mangrove cold tolerance threshold [@cavanaugh2014]. Bottom panel shows total number of days below freezing (light blue) and longest consecutive cold spell (dark blue) per year. Air temperature data from Tampa International Airport (NOAA NCEI station USW00012842)"
 
rlefun <- function(x){
  runs <- rle(x)
  if(!any(runs$values)) return(0)
  max(runs$lengths[runs$values])
}

yrstr <- 1980

toplo <- tempdat |> 
  mutate(
    date = lubridate::ymd_hms(date), 
    yr = lubridate::year(date), 
    below = value < 0
  ) |> 
  filter(yr >= yrstr) |>
  summarize(
    temp = min(value), 
    nbelow = sum(below), 
    ncont = rlefun(below), 
    .by = yr
  )

toplo1 <- toplo
p1 <- ggplot(toplo1, aes(x = yr, y = temp)) +  
  geom_line() + 
  geom_point() +
  geom_hline(aes(color = "Mangrove threshold", yintercept = -4), linetype = "dashed") +
  scale_x_continuous(expand = c(0.1, 0.1)) + 
  scale_y_continuous(breaks = scales::pretty_breaks()) +
  scale_color_manual(values = "cyan3") +
  coord_cartesian(xlim = c(1978, 2026), expand = F) +
  theme_minimal() + 
  labs(
    x = NULL,
    color = NULL,
    y = 'Minimum air temp (Â°C)'
  )

toplo2 <- toplo |> 
  select(-temp) |> 
  pivot_longer(
    cols = -yr, 
    names_to = 'var', 
    values_to = 'value'
  ) |> 
  mutate(var = factor(var, levels = c('ncont', 'nbelow'), 
    labels = c('Longest cold spell', 'Total days')))

p2 <- ggplot(toplo2, aes(x = yr, y = value, fill = var)) + 
  geom_bar(stat = 'identity') + 
  scale_fill_manual(values = c('deepskyblue4', 'deepskyblue1')) +
  scale_y_continuous(breaks = scales::pretty_breaks()) +
  coord_cartesian(xlim = c(1978, 2026), expand = F) +
  theme_minimal() +
  labs(
    x = NULL,
    fill = NULL,
    y = 'Number of days\nbelow freezing'
  )

p <- p1 + p2 + 
  plot_layout(ncol = 1, height = c(2, 1), guides = 'collect') &
  theme(legend.position = 'bottom')

p
```

## References